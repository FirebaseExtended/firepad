var Firepad=function(){var t=t||{};t.utils={},t.utils.makeEventEmitter=function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,r){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:r})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var r=this.eventListeners_[t]||[],n=0;r.length>n;n++)if(r[n].callback===e)return r.splice(n,1),void 0},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],r=0;e.length>r;r++)e[r].callback.apply(e[r].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_&&-1===this.allowedEvents_.indexOf(t))throw Error('Unknown event "'+t+'"')}},t.utils.elt=function(e,r,n){var o=document.createElement(e);if("string"==typeof r)t.utils.setTextContent(o,r);else if(r)for(var i=0;r.length>i;++i)o.appendChild(r[i]);for(var s in n||{})o.setAttribute(s,n[s]);return o},t.utils.setTextContent=function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},t.utils.on=function(t,e,r){t.addEventListener?t.addEventListener(e,r,!1):t.attachEvent&&t.attachEvent("on"+e,r)},t.utils.off=function(t,e,r){t.removeEventListener?t.removeEventListener(e,r,!1):t.detachEvent&&t.detachEvent("on"+e,r)},t.utils.preventDefault=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},t.utils.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},t.utils.stopEvent=function(e){t.utils.preventDefault(e),t.utils.stopPropagation(e)},t.utils.stopEventAnd=function(e){return function(r){return e(r),t.utils.stopEvent(r),!1}},t.utils.assert=function(t,e){if(!t)throw Error(e||"assertion error")};var t=t||{};t.Span=function(){function t(t,e){this.pos=t,this.length=e}return t.prototype.end=function(){return this.pos+this.length},t}();var t=t||{};t.TextOp=function(){function e(t){this.type=t,this.chars=null,this.text=null,this.attributes=null,"insert"===t?(this.text=arguments[1],r.assert("string"==typeof this.text),this.attributes=arguments[2]||{},r.assert("object"==typeof this.attributes)):"delete"===t?(this.chars=arguments[1],r.assert("number"==typeof this.chars)):"retain"===t&&(this.chars=arguments[1],r.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},r.assert("object"==typeof this.attributes))}var r=t.utils;return e.prototype.isInsert=function(){return"insert"===this.type},e.prototype.isDelete=function(){return"delete"===this.type},e.prototype.isRetain=function(){return"retain"===this.type},e.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},e.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},e.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},e}();var t=t||{};t.TextOperation=function(){"use strict";function e(){return this&&this.constructor===e?(this.ops=[],this.baseLength=0,this.targetLength=0,void 0):new e}function r(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function n(t){return t.ops[0].isRetain()?t.ops[0].chars:0}var o=t.TextOp,i=t.utils;return e.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;this.ops.length>e;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},e.prototype.retain=function(t,e){if("number"!=typeof t||0>t)throw Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,e=e||{};var r=this.ops.length>0?this.ops[this.ops.length-1]:null;return r&&r.isRetain()&&r.attributesEqual(e)?r.chars+=t:this.ops.push(new o("retain",t,e)),this},e.prototype.insert=function(t,e){if("string"!=typeof t)throw Error("insert expects a string");if(""===t)return this;e=e||{},this.targetLength+=t.length;var r=this.ops.length>0?this.ops[this.ops.length-1]:null,n=this.ops.length>1?this.ops[this.ops.length-2]:null;return r&&r.isInsert()&&r.attributesEqual(e)?r.text+=t:r&&r.isDelete()?n&&n.isInsert()&&n.attributesEqual(e)?n.text+=t:(this.ops[this.ops.length-1]=new o("insert",t,e),this.ops.push(r)):this.ops.push(new o("insert",t,e)),this},e.prototype["delete"]=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||0>t)throw Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var e=this.ops.length>0?this.ops[this.ops.length-1]:null;return e&&e.isDelete()?e.chars+=t:this.ops.push(new o("delete",t)),this},e.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},e.prototype.clone=function(){for(var t=new e,r=0;this.ops.length>r;r++)this.ops[r].isRetain()?t.retain(this.ops[r].chars,this.ops[r].attributes):this.ops[r].isInsert()?t.insert(this.ops[r].text,this.ops[r].attributes):t["delete"](this.ops[r].chars);return t},e.prototype.toString=function(){var t=Array.prototype.map||function(t){for(var e=this,r=[],n=0,o=e.length;o>n;n++)r[n]=t(e[n]);return r};return t.call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},e.prototype.toJSON=function(){for(var t=[],e=0;this.ops.length>e;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},e.fromJSON=function(t){for(var r=new e,n=0,o=t.length;o>n;n++){var s=t[n],a={};"object"==typeof s&&(a=s,n++,s=t[n]),"number"==typeof s?s>0?r.retain(s,a):r["delete"](-s):(i.assert("string"==typeof s),r.insert(s,a))}return r},e.prototype.apply=function(t,e,r){var n=this;if(e=e||[],r=r||[],t.length!==n.baseLength)throw Error("The operation's base length must be equal to the string's length.");for(var o,s,a=[],h=0,u=0,c=this.ops,p=0,l=c.length;l>p;p++){var f=c[p];if(f.isRetain()){if(u+f.chars>t.length)throw Error("Operation can't retain more characters than are left in the string.");for(a[h++]=t.slice(u,u+f.chars),o=0;f.chars>o;o++){var d=e[u+o]||{},g={};for(s in d)g[s]=d[s],i.assert(g[s]!==!1);for(s in f.attributes)f.attributes[s]===!1?delete g[s]:g[s]=f.attributes[s],i.assert(g[s]!==!1);r.push(g)}u+=f.chars}else if(f.isInsert())for(a[h++]=f.text,o=0;f.text.length>o;o++){var v={};for(s in f.attributes)v[s]=f.attributes[s],i.assert(v[s]!==!1);r.push(v)}else u+=f.chars}if(u!==t.length)throw Error("The operation didn't operate on the whole string.");var m=a.join("");return i.assert(m.length===r.length),m},e.prototype.invert=function(t){for(var r=0,n=new e,o=this.ops,i=0,s=o.length;s>i;i++){var a=o[i];a.isRetain()?(n.retain(a.chars),r+=a.chars):a.isInsert()?n["delete"](a.text.length):(n.insert(t.slice(r,r+a.chars)),r+=a.chars)}return n},e.prototype.compose=function(t){function r(t,e,r){var n,o={};for(n in t)o[n]=t[n];for(n in e)r&&e[n]===!1?delete o[n]:o[n]=e[n];return o}var n=this;if(n.targetLength!==t.baseLength)throw Error("The base length of the second operation has to be the target length of the first operation");for(var o,i=new e,s=n.clone().ops,a=t.clone().ops,h=0,u=0,c=s[h++],p=a[u++];;){if(c===void 0&&p===void 0)break;if(c&&c.isDelete())i["delete"](c.chars),c=s[h++];else if(p&&p.isInsert())i.insert(p.text,p.attributes),p=a[u++];else{if(c===void 0)throw Error("Cannot compose operations: first operation is too short.");if(p===void 0)throw Error("Cannot compose operations: first operation is too long.");if(c.isRetain()&&p.isRetain())o=r(c.attributes,p.attributes),c.chars>p.chars?(i.retain(p.chars,o),c.chars-=p.chars,p=a[u++]):c.chars===p.chars?(i.retain(c.chars,o),c=s[h++],p=a[u++]):(i.retain(c.chars,o),p.chars-=c.chars,c=s[h++]);else if(c.isInsert()&&p.isDelete())c.text.length>p.chars?(c.text=c.text.slice(p.chars),p=a[u++]):c.text.length===p.chars?(c=s[h++],p=a[u++]):(p.chars-=c.text.length,c=s[h++]);else if(c.isInsert()&&p.isRetain())o=r(c.attributes,p.attributes,!0),c.text.length>p.chars?(i.insert(c.text.slice(0,p.chars),o),c.text=c.text.slice(p.chars),p=a[u++]):c.text.length===p.chars?(i.insert(c.text,o),c=s[h++],p=a[u++]):(i.insert(c.text,o),p.chars-=c.text.length,c=s[h++]);else{if(!c.isRetain()||!p.isDelete())throw Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(p));c.chars>p.chars?(i["delete"](p.chars),c.chars-=p.chars,p=a[u++]):c.chars===p.chars?(i["delete"](p.chars),c=s[h++],p=a[u++]):(i["delete"](c.chars),p.chars-=c.chars,c=s[h++])}}}return i},e.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=n(this),o=n(t),i=r(this),s=r(t);return i&&s?i.isInsert()&&s.isInsert()?e+i.text.length===o:i.isDelete()&&s.isDelete()?o+s.chars===e||e===o:!1:!1},e.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=n(this),o=n(t),i=r(this),s=r(t);return i&&s?i.isInsert()&&s.isInsert()?e+i.text.length===o||e===o:i.isDelete()&&s.isDelete()?o+s.chars===e:!1:!1},e.transformAttributes=function(t,e){var r,n={},o={},s={};for(r in t)s[r]=!0;for(r in e)s[r]=!0;for(r in s){var a=t[r],h=e[r];i.assert(null!=a||null!=h),null==a?o[r]=h:null==h?n[r]=a:a===h||(n[r]=a)}return[n,o]},e.transform=function(t,r){if(t.baseLength!==r.baseLength)throw Error("Both operations have to have the same base length");for(var n=new e,o=new e,i=t.clone().ops,s=r.clone().ops,a=0,h=0,u=i[a++],c=s[h++];;){if(u===void 0&&c===void 0)break;if(u&&u.isInsert())n.insert(u.text,u.attributes),o.retain(u.text.length),u=i[a++];else if(c&&c.isInsert())n.retain(c.text.length),o.insert(c.text,c.attributes),c=s[h++];else{if(u===void 0)throw Error("Cannot transform operations: first operation is too short.");if(c===void 0)throw Error("Cannot transform operations: first operation is too long.");var p;if(u.isRetain()&&c.isRetain()){var l=e.transformAttributes(u.attributes,c.attributes);u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=c.chars,u=i[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=i[a++]),n.retain(p,l[0]),o.retain(p,l[1])}else if(u.isDelete()&&c.isDelete())u.chars>c.chars?(u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(u=i[a++],c=s[h++]):(c.chars-=u.chars,u=i[a++]);else if(u.isDelete()&&c.isRetain())u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=c.chars,u=i[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=i[a++]),n["delete"](p);else{if(!u.isRetain()||!c.isDelete())throw Error("The two operations aren't compatible");u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=u.chars,u=i[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=i[a++]),o["delete"](p)}}}return[n,o]},e}();var t=t||{};t.AnnotationList=function(){function e(t,e){if(!t)throw Error("AnnotationList assertion failed"+(e?": "+e:""))}function r(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function n(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}function o(t){this.head_=new i(0,a),this.changeHandler_=t}function i(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}var s=t.Span;r.prototype.getAttachedObject=function(){return this.attachedObject_},n.prototype.attachObject=function(t){this.node_.attachedObject=t};var a={equals:function(){return!1}};return o.prototype.insertAnnotatedSpan=function(t,r){this.wrapOperation_(new s(t.pos,0),function(n,o){e(!o||null===o.next);var s=new i(t.length,r);if(o){e(t.pos>n&&t.pos<n+o.length);var h=new i(0,a);return h.next=new i(t.pos-n,o.annotation),h.next.next=s,s.next=new i(n+o.length-t.pos,o.annotation),h.next}return s})},o.prototype.removeSpan=function(t){0!==t.length&&this.wrapOperation_(t,function(r,n){e(null!==n);var o=new i(0,a),s=o;for(t.pos>r&&(s.next=new i(t.pos-r,n.annotation),s=s.next);t.end()>r+n.length;)r+=n.length,n=n.next;var h=r+n.length-t.end();return h>0&&(s.next=new i(h,n.annotation)),o.next})},o.prototype.updateSpan=function(t,r){0!==t.length&&this.wrapOperation_(t,function(n,o){e(null!==o);var s=new i(0,a),h=s,u=n,c=t.pos-u;for(e(o.length>c),c>0&&(h.next=new i(c,o.annotation),h=h.next,u+=h.length);null!==o&&t.end()>=n+o.length;){var p=n+o.length-u;h.next=new i(p,r(o.annotation,p)),h=h.next,n+=o.length,o=o.next,u=n}var l=t.end()-u;return l>0&&(e(o.length>l),h.next=new i(l,r(o.annotation,l)),h=h.next,u+=h.length,h.next=new i(n+o.length-u,o.annotation)),s.next})},o.prototype.wrapOperation_=function(t,e){if(0>t.pos)throw Error("Span start cannot be negative.");var o,s=[],a=[],h=this.getAffectedNodes_(t);null!==h.start?(o=h.end.next,h.end.next=null):o=h.succ;var u=e(h.startPos,h.start),c=!1,p=!1;if(u){this.mergeNodesWithSameAnnotations_(u);var l;for(h.pred&&h.pred.annotation.equals(u.annotation)?(c=!0,u.length+=h.pred.length,h.beforePred.next=u,l=h.predPos):(h.beforeStart.next=u,l=h.startPos);u.next;)a.push(new n(l,u)),l+=u.length,u=u.next;h.succ&&h.succ.annotation.equals(u.annotation)?(u.length+=h.succ.length,p=!0,u.next=h.succ.next):u.next=o,a.push(new n(l,u))}else h.pred&&h.succ&&h.pred.annotation.equals(h.succ.annotation)?(c=!0,p=!0,u=new i(h.pred.length+h.succ.length,h.pred.annotation),h.beforePred.next=u,u.next=h.succ.next,a.push(new n(h.startPos-h.start.length,u))):h.beforeStart.next=o;c&&s.push(new r(h.predPos,h.pred));for(var f=h.startPos,d=h.start;null!==d;)s.push(new r(f,d)),f+=d.length,d=d.next;p&&s.push(new r(f,h.succ)),this.changeHandler_(s,a)},o.prototype.getAffectedNodes_=function(t){for(var e={},r=null,n=this.head_,o=n.next,i=0;null!==o&&t.pos>=i+o.length;)i+=o.length,r=n,n=o,o=o.next;if(null===o&&(0!==t.length||t.pos!==i))throw Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=i,e.start=0===t.length&&t.pos===i?null:o,e.beforeStart=n,i===t.pos&&i>0?(e.pred=n,e.predPos=i-n.length,e.beforePred=r):e.pred=null;null!==o&&t.end()>i;)i+=o.length,n=o,o=o.next;if(t.end()>i)throw Error("Span end exceeds the bounds of the AnnotationList.");return e.end=0===t.length&&t.end()===i?null:n,e.succ=i===t.end()?o:null,e},o.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,r=t;r;)e&&e.annotation.equals(r.annotation)?(e.length+=r.length,e.next=r.next):e=r,r=r.next},o.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},o.prototype.getAnnotatedSpansForPos=function(t){for(var e=0,n=this.head_.next,o=null;null!==n&&t>=e+n.length;)e+=n.length,o=n,n=n.next;if(null===n&&e!==t)throw Error("pos exceeds the bounds of the AnnotationList");var i=[];return e===t&&o&&i.push(new r(e-o.length,o)),n&&i.push(new r(e,n)),i},o.prototype.getAnnotatedSpansForSpan=function(t){if(0===t.length)return[];for(var e=[],r=this.getAffectedNodes_(t),n=r.startPos,o=r.start;null!==o&&t.end()>n;){var i=Math.max(n,t.pos),a=Math.min(n+o.length,t.end()),h=new s(i,a-i);h.annotation=o.annotation,e.push(h),n+=o.length,o=o.next}return e},o.prototype.count=function(){for(var t=0,r=this.head_.next,n=null;null!==r;)n&&e(!n.annotation.equals(r.annotation)),n=r,r=r.next,t++;return t},i.prototype.clone=function(){var t=new i(this.spanLength,this.annotation);return t.next=this.next,t},o}();var t=t||{};t.Cursor=function(){"use strict";function t(t,e){this.position=t,this.selectionEnd=e}return t.fromJSON=function(e){return new t(e.position,e.selectionEnd)},t.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},t.prototype.compose=function(t){return t},t.prototype.transform=function(e){function r(t){for(var r=t,n=e.ops,o=0,i=e.ops.length;i>o&&(n[o].isRetain()?t-=n[o].chars:n[o].isInsert()?r+=n[o].text.length:(r-=Math.min(t,n[o].chars),t-=n[o].chars),!(0>t));o++);return r}var n=r(this.position);return this.position===this.selectionEnd?new t(n,n):new t(n,r(this.selectionEnd))},t}();var t=t||{};t.FirebaseAdapter=function(){function e(t,e,r){this.ref_=t,this.ready_=!1,this.document_=new o,this.revision_=0,this.pendingReceivedRevisions_={},this.setUserId(e),this.setColor(r),t.root().child(".info/connected").on("value",function(t){t.val()===!0&&this.initializeUserData_()},this);var n=this;setTimeout(function(){n.monitorCursors_(),n.monitorHistory_()},0)}function r(t,e){if(!t)throw Error(e||"assertion error")}function n(t){if(0===t)return"A0";for(var e="";t>0;){var r=t%a.length;e=a[r]+e,t-=r,t/=a.length}var n=a[e.length+9];return n+e}var o=t.TextOperation,i=t.utils,s=100;i.makeEventEmitter(e,["ready","cursor","operation","ack","retry"]),e.prototype.setUserId=function(t){this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel()),this.userId_=t,this.userRef_=this.ref_.child("users").child(t),this.initializeUserData_()},e.prototype.isHistoryEmpty=function(){return r(this.ready_,"Not ready yet."),0===this.revision_},e.prototype.sendOperation=function(t,e){var o=this;r(this.document_.targetLength===t.baseLength,"sendOperation() called with invalid operation.");var i=n(this.revision_);this.ref_.child("history").child(i).transaction(function(e){return null===e?{a:o.userId_,o:t.toJSON()}:void 0},function(t,r){if(t)throw console.error("Transaction failure!",t),t;r?o.sendCursor(e):o.trigger("retry")},!1),this.sent_={id:i,op:t}},e.prototype.sendCursor=function(t){this.userRef_.child("cursor").set(t),this.cursor_=t},e.prototype.setColor=function(t){this.userRef_.child("color").set(t),this.color_=t},e.prototype.getDocument=function(){return this.document_},e.prototype.registerCallbacks=function(t){for(var e in t)this.on(e,t[e])},e.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null)},e.prototype.monitorCursors_=function(){var t=this.ref_.child("users"),e=this,r={};t.on("child_added",function(t){var n=t.name();n!==e.userId_&&(r[n]=function(t){var r=t.val()||{};e.trigger("cursor",n,r.cursor,r.color)},t.ref().on("value",r[n]))}),t.on("child_removed",function(t){var n=t.name();t.ref().off("value",r[n]),e.trigger("cursor",n,null)})},e.prototype.monitorHistory_=function(){var t=this;this.ref_.child("checkpoint").once("value",function(e){var r=e.child("rev").val(),o=e.child("op").val();null!=o&&null!=r?(t.pendingReceivedRevisions_[n(r)]={o:o,a:"checkpoint"},t.checkpointRevision_=r,t.monitorHistoryStartingAt_(t.checkpointRevision_+1)):(t.checkpointRevision_=0,t.monitorHistoryStartingAt_(t.checkpointRevision_))})},e.prototype.monitorHistoryStartingAt_=function(t){var e=this.ref_.child("history").startAt(null,n(t)),r=this;e.on("child_added",function(t){var e=t.name();r.pendingReceivedRevisions_[e]=t.val(),r.ready_&&r.handlePendingReceivedRevisions_()}),e.once("value",function(){r.handleInitialRevisions_()})},e.prototype.handleInitialRevisions_=function(){r(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var t=n(this.revision_),e=this.pendingReceivedRevisions_;e[t];){var i=e[t].a,s=o.fromJSON(e[t].o);delete e[t],this.document_.targetLength!==s.baseLength?console.log("Invalid operation.",i,s):this.document_=this.document_.compose(s),this.revision_++,t=n(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0,this.trigger("ready")},e.prototype.handlePendingReceivedRevisions_=function(){for(var t=this.pendingReceivedRevisions_,e=n(this.revision_);t[e];){var r=t[e].a,i=o.fromJSON(t[e].o);delete t[e],this.revision_++,i.baseLength!==this.document_.targetLength?console.log("Invalid operation.",r,i):(this.document_=this.document_.compose(i),this.sent_&&e===this.sent_.id&&this.sent_.op.equals(i)&&r===this.userId_?(0===this.revision_%s&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):this.trigger("operation",i)),e=n(this.revision_)}},e.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({op:this.document_.toJSON(),rev:this.revision_-1})};var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";return e}();var t=t||{};t.RichTextToolbar=function(){function e(){this.element_=this.makeElement_()}var r=t.utils;return r.makeEventEmitter(e,["bold","italic","underline","font-size"]),e.prototype.element=function(){return this.element_},e.prototype.makeElement_=function(){var t=this,e=r.elt("a","B",{"class":"firepad-btn firepad-btn-bold"});r.on(e,"click",r.stopEventAnd(function(){t.trigger("bold")}));var n=r.elt("a","I",{"class":"firepad-btn firepad-btn-italic"});r.on(n,"click",r.stopEventAnd(function(){t.trigger("italic")}));var o=r.elt("a","U",{"class":"firepad-btn firepad-btn-underline"});r.on(o,"click",r.stopEventAnd(function(){t.trigger("underline")}));var i=this.makeFontSizeDropdown_();return r.elt("div",[r.elt("div",[i],{"class":"firepad-btn-group"}),r.elt("div",[e,n,o],{"class":"firepad-btn-group"})],{"class":"firepad-toolbar"})},e.prototype.makeFontSizeDropdown_=function(){function t(){s?(i.style.display="",r.off(document,"click",t)):(i.style.display="block",r.on(document,"click",t)),s=!s}function e(e,o){var s=r.elt("a",e);r.on(s,"click",r.stopEventAnd(function(){t(),n.trigger("font-size",o)})),i.appendChild(s)}var n=this,o=r.elt("a","Size â–¾",{"class":"firepad-btn firepad-dropdown"}),i=r.elt("ul",[],{"class":"firepad-dropdown-menu"});o.appendChild(i);var s=!1;return e("Default",!1),e("12",12),e("14",14),e("18",18),e("24",24),e("32",32),e("42",42),r.on(o,"click",r.stopEventAnd(t)),o},e}();var t=t||{};t.WrappedOperation=function(){"use strict";function t(t,e){this.wrapped=t,this.meta=e}function e(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}function r(t,r){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(r);var n={};return e(t,n),e(r,n),n}return r}function n(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return t.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},t.prototype.invert=function(){var e=this.meta;return new t(this.wrapped.invert.apply(this.wrapped,arguments),e&&"object"==typeof e&&"function"==typeof e.invert?e.invert.apply(e,arguments):e)},t.prototype.compose=function(e){return new t(this.wrapped.compose(e.wrapped),r(this.meta,e.meta))},t.transform=function(e,r){var o=e.wrapped.constructor.transform,i=o(e.wrapped,r.wrapped);return[new t(i[0],n(e.meta,r.wrapped)),new t(i[1],n(r.meta,e.wrapped))]},t}();var t=t||{};t.UndoManager=function(){"use strict";function t(t){this.maxItems=t||50,this.state=r,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function e(t,e){for(var r=[],n=e.constructor,o=t.length-1;o>=0;o--){var i=n.transform(t[o],e);"function"==typeof i[0].isNoop&&i[0].isNoop()||r.push(i[0]),e=i[1]}return r.reverse()}var r="normal",n="undoing",o="redoing";return t.prototype.add=function(t,e){if(this.state===n)this.redoStack.push(t),this.dontCompose=!0;else if(this.state===o)this.undoStack.push(t),this.dontCompose=!0;else{var r=this.undoStack;!this.dontCompose&&e&&r.length>0?r.push(t.compose(r.pop())):(r.push(t),r.length>this.maxItems&&r.shift()),this.dontCompose=!1,this.redoStack=[]}},t.prototype.transform=function(t){this.undoStack=e(this.undoStack,t),this.redoStack=e(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=n,0===this.undoStack.length)throw Error("undo not possible");t(this.undoStack.pop()),this.state=r},t.prototype.performRedo=function(t){if(this.state=o,0===this.redoStack.length)throw Error("redo not possible");t(this.redoStack.pop()),this.state=r},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===n},t.prototype.isRedoing=function(){return this.state===o},t}();var t=t||{};t.Client=function(){"use strict";function t(){this.state=o}function e(){}function r(t){this.outstanding=t}function n(t,e){this.outstanding=t,this.buffer=e}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.transformCursor=function(t){return this.state.transformCursor(t)},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(){throw Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(){throw Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(e),new r(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(){throw Error("There is no pending operation.")},e.prototype.serverRetry=function(){throw Error("There is no pending operation.")},e.prototype.transformCursor=function(t){return t};var o=new e;return t.AwaitingConfirm=r,r.prototype.applyClient=function(t,e){return new n(this.outstanding,e)},r.prototype.applyServer=function(t,e){var n=e.constructor.transform(this.outstanding,e);return t.applyOperation(n[1]),new r(n[0])},r.prototype.serverAck=function(){return o},r.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},r.prototype.transformCursor=function(t){return t.transform(this.outstanding)},t.AwaitingWithBuffer=n,n.prototype.applyClient=function(t,e){var r=this.buffer.compose(e);return new n(this.outstanding,r)},n.prototype.applyServer=function(t,e){var r=e.constructor.transform,o=r(this.outstanding,e),i=r(this.buffer,o[1]);return t.applyOperation(i[1]),new n(o[0],i[0])},n.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new r(e)},n.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new r(this.buffer)},n.prototype.transformCursor=function(t){return t.transform(this.outstanding).transform(this.buffer)},t}();var t=t||{};t.EditorClient=function(){"use strict";function e(t,e){this.cursorBefore=t,this.cursorAfter=e}function r(t,e){this.id=t,this.editorAdapter=e,this.li=document.createElement("li")}function n(t,e){s.call(this),this.serverAdapter=t,this.editorAdapter=e,this.undoManager=new h,this.clients={};var r=this;this.editorAdapter.registerCallbacks({change:function(t,e){r.onChange(t,e)},cursorActivity:function(){r.onCursorActivity()},blur:function(){r.onBlur()}}),this.editorAdapter.registerUndo(function(){r.undo()}),this.editorAdapter.registerRedo(function(){r.redo()}),this.serverAdapter.registerCallbacks({ack:function(){r.serverAck()},retry:function(){r.serverRetry()},operation:function(t){r.applyServer(t)},cursor:function(t,e,n){var o=r.getClientObject(t);e?(o.setColor(n),o.updateCursor(r.transformCursor(a.fromJSON(e)))):o.removeCursor()}})}function o(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}function i(t){return t[t.length-1]}var s=t.Client,a=t.Cursor,h=t.UndoManager,u=t.WrappedOperation;return e.prototype.invert=function(){return new e(this.cursorAfter,this.cursorBefore)},e.prototype.compose=function(t){return new e(this.cursorBefore,t.cursorAfter)},e.prototype.transform=function(t){return new e(this.cursorBefore.transform(t),this.cursorAfter.transform(t))},r.prototype.setColor=function(t){this.color=t},r.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,this.color,this.id)},r.prototype.removeCursor=function(){this.mark&&this.mark.clear()},o(n,s),n.prototype.getClientObject=function(t){var e=this.clients[t];return e?e:this.clients[t]=new r(t,this.editorAdapter)},n.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},n.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},n.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},n.prototype.onChange=function(t,r){var n=this.cursor;this.updateCursor();var o=this.undoManager.undoStack.length>0&&r.shouldBeComposedWithInverted(i(this.undoManager.undoStack).wrapped),s=new e(this.cursor,n);this.undoManager.add(new u(r,s),o),this.applyClient(t)},n.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},n.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},n.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null)},n.prototype.sendCursor=function(t){this.state instanceof s.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},n.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t,this.cursor)},n.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new u(t,null))},n}();var t=t||{};t.CodeMirrorAdapter=function(){"use strict";function e(t){this.cm=t,this.ignoreNextChange=!1,s(this,"onChange"),s(this,"onCursorActivity"),s(this,"onFocus"),s(this,"onBlur"),t.on("change",this.onChange),t.on("cursorActivity",this.onCursorActivity),t.on("focus",this.onFocus),t.on("blur",this.onBlur)}function r(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function n(t,e){return 0===r(t,e)}function o(t,e){return 0>=r(t,e)}function i(t){return t.indexFromPos({line:t.lastLine(),ch:0})+t.getLine(t.lastLine()).length}function s(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}var a=t.TextOperation,h=t.Cursor;e.prototype.detach=function(){this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},e.operationFromCodeMirrorChange=function(t,e){function r(t){return t[t.length-1]}function n(t){if(0===t.length)return 0;for(var e=0,r=0;t.length>r;r++)e+=t[r].length;return e+t.length-1}function s(t,e){return function(i){return o(i,e.from)?t(i):o(e.to,i)?t({line:i.line+e.text.length-1-(e.to.line-e.from.line),ch:e.to.line<i.line?i.ch:1>=e.text.length?i.ch-(e.to.ch-e.from.ch)+n(e.text):i.ch-e.to.ch+r(e.text).length})+n(e.removed)-n(e.text):e.from.line===i.line?t(e.from)+i.ch-e.from.ch:t(e.from)+n(e.removed.slice(0,i.line-e.from.line))+1+i.ch}}for(var h=[],u=0;t;)h[u++]=t,t=t.next;var c=i(e),p=(new a).retain(c),l=(new a).retain(c),f=function(t){return e.indexFromPos(t)};for(u=h.length-1;u>=0;u--){t=h[u],f=s(f,t);var d=f(t.from),g=c-d-n(t.text);p=(new a).retain(d)["delete"](n(t.removed)).insert(t.text.join("\n")).retain(g).compose(p),l=l.compose((new a).retain(d)["delete"](n(t.text)).insert(t.removed.join("\n")).retain(g)),c+=n(t.removed)-n(t.text)}return[p,l]},e.applyOperationToCodeMirror=function(t,e){e.operation(function(){for(var r=t.ops,n=0,o=0,i=r.length;i>o;o++){var s=r[o];if(s.isRetain())n+=s.chars;else if(s.isInsert())e.replaceRange(s.text,e.posFromIndex(n)),n+=s.text.length;else if(s.isDelete()){var a=e.posFromIndex(n),h=e.posFromIndex(n+s.chars);e.replaceRange("",a,h)}}})},e.prototype.registerCallbacks=function(t){this.callbacks=t},e.prototype.onChange=function(t,r){if(!this.ignoreNextChange){var n=e.operationFromCodeMirrorChange(r,this.cm);this.trigger("change",n[0],n[1])}this.ignoreNextChange=!1},e.prototype.onCursorActivity=e.prototype.onFocus=function(){this.trigger("cursorActivity")
},e.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},e.prototype.getValue=function(){return this.cm.getValue()},e.prototype.getCursor=function(){var t,e=this.cm,r=e.getCursor(),o=e.indexFromPos(r);if(e.somethingSelected()){var i=e.getCursor(!0),s=n(r,i)?e.getCursor(!1):i;t=e.indexFromPos(s)}else t=o;return new h(o,t)},e.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))};var u=function(){if("undefined"!=typeof document){var t={},e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e);var r=e.sheet;return function(e){t[e]||(t[e]=!0,r.insertRule(e,(r.cssRules||r.rules).length))}}}();return e.prototype.setOtherCursor=function(t,e,r){var n=this.cm.posFromIndex(t.position);if(t.position===t.selectionEnd){var o=this.cm.cursorCoords(n),i=document.createElement("pre");return i.className="other-client",i.style.borderLeftWidth="2px",i.style.borderLeftStyle="solid",i.innerHTML="&nbsp;",i.style.borderLeftColor=e,i.style.height=.9*(o.bottom-o.top)+"px",i.style.marginTop=o.top-o.bottom+"px",i.style.zIndex=0,i.setAttribute("data-clientid",r),i.style.zIndex=0,this.cm.addWidget(n,i,!1),{clear:function(){var t=i.parentNode;t&&t.removeChild(i)}}}var s=/^#([0-9a-fA-F]{6})$/.exec(e);if(!s)throw Error("only six-digit hex colors are allowed.");var a="selection-"+s[1],h="."+a+" { background: "+e+"; }";u(h);var c,p;return t.selectionEnd>t.position?(c=n,p=this.cm.posFromIndex(t.selectionEnd)):(c=this.cm.posFromIndex(t.selectionEnd),p=n),this.cm.markText(c,p,{className:a})},e.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},e.prototype.applyOperation=function(t){t.isNoop()||(this.ignoreNextChange=!0),e.applyOperationToCodeMirror(t,this.cm)},e.prototype.registerUndo=function(t){this.cm.undo=t},e.prototype.registerRedo=function(t){this.cm.redo=t},e.prototype.invertOperation=function(t){return t.invert(this.cm.getValue())},e}();var t=t||{};t.RichTextCodeMirror=function(){function e(t,e){this.codeMirror=t,this.options_=e||{};var r=this;this.annotationList_=new o(function(t,e){r.onAnnotationsChanged_(t,e)}),this.initAnnotationList_(),this.codeMirror.on("change",function(t,e){r.onCodeMirrorChange_(e)}),this.currentAttributes_={},this.codeMirror.on("cursorActivity",function(){r.updateCurrentAttributes_()}),this.changeId_=0,this.outstandingChanges_={}}function r(t){this.attributes=t||{}}function n(t){for(var e in t)return!1;return!0}var o=t.AnnotationList,i=t.Span,s=t.utils,a="cmrt-",h="cmrt-";return s.makeEventEmitter(e,["change","attributesChange"]),e.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},e.prototype.toggleAttribute=function(t){if(this.emptySelection_()){var e=this.getCurrentAttributes_();e[t]===!0?delete e[t]:e[t]=!0,this.currentAttributes_=e}else{var r=this.getCurrentAttributes_(),n=r[t]!==!0;this.setAttribute(t,n)}},e.prototype.setAttribute=function(t,e){var r=this.codeMirror;if(this.emptySelection_()){var n=this.getCurrentAttributes_();e===!1?delete n[t]:n[t]=e,this.currentAttributes_=n}else{var o={};o[t]=e,this.updateTextAttributes(r.indexFromPos(r.getCursor("start")),r.indexFromPos(r.getCursor("end")),o),this.updateCurrentAttributes_()}},e.prototype.updateTextAttributes=function(t,e,o,s){if(!n(o)){var a={},h=a,u=t;this.annotationList_.updateSpan(new i(t,e-t),function(t,e){var i={};for(var a in t.attributes)i[a]=t.attributes[a];var c={},p={};for(a in o){var l=o[a];l===!1?a in i&&(p[a]=i[a],c[a]=!1,delete i[a]):i[a]!==l&&(p[a]=i[a]||!1,c[a]=l,i[a]=l)}return n(c)||(h.next={start:u,end:u+e,attributes:c,attributesInverse:p,origin:s},h=h.next),u+=e,new r(i)}),a.next&&this.trigger("attributesChange",this,a.next)}},e.prototype.insertText=function(t,e,r,n){this.changeId_++;var o=h+this.changeId_;this.outstandingChanges_[o]={origOrigin:n,attributes:r};var i=this.codeMirror;i.replaceRange(e,i.posFromIndex(t),null,o)},e.prototype.removeText=function(t,e,r){var n=this.codeMirror;n.replaceRange("",n.posFromIndex(t),n.posFromIndex(e),r)},e.prototype.getAttributeSpans=function(t,e){for(var r=[],n=this.annotationList_.getAnnotatedSpansForSpan(new i(t,e-t)),o=0;n.length>o;o++)r.push({length:n[o].length,attributes:n[o].annotation.attributes});return r},e.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},e.prototype.getText=function(t,e){var r=this.codeMirror.posFromIndex(t),n=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(r,n)},e.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new i(0,t),new r)},e.prototype.onAnnotationsChanged_=function(t,e){for(var r,n=0;t.length>n;n++)r=t[n].getAttachedObject(),r&&r.clear();for(n=0;e.length>n;n++){var o=e[n].annotation,i="";for(var s in o.attributes){var h=o.attributes[s];i+=" "+(this.options_.cssPrefix||a)+s,h!==!0&&(i+=h)}if(""!==i){var u=this.codeMirror.posFromIndex(e[n].pos),c=this.codeMirror.posFromIndex(e[n].pos+e[n].length);r=this.codeMirror.markText(u,c,{className:i}),e[n].attachObject(r)}}},e.prototype.onCodeMirrorChange_=function(t){for(var e={},n=e;t;){var o=this.codeMirror.indexFromPos(t.from),s=t.removed.join("\n");if(s.length>0){for(var a=this.annotationList_.getAnnotatedSpansForSpan(new i(o,s.length)),h=0,u=0;a.length>u;u++){var c=a[u];n.next={start:o,end:o+c.length,removedAttributes:c.annotation.attributes,removed:s.substr(h,c.length),attributes:{},text:"",origin:t.origin},n=n.next,h+=c.length}this.annotationList_.removeSpan(new i(o,s.length))}var p=t.text.join("\n"),l=t.origin;if(p.length>0){var f;"+input"===t.origin||"paste"===t.origin?f=this.getCurrentAttributes_():l in this.outstandingChanges_?(f=this.outstandingChanges_[l].attributes,l=this.outstandingChanges_[l].origOrigin,delete this.outstandingChanges_[l]):f={},this.annotationList_.insertAnnotatedSpan(new i(o,p.length),new r(f)),n.next={start:o,end:o,removedAttributes:{},removed:"",text:p,attributes:f,origin:l},n=n.next}t=t.next}e.next&&this.trigger("change",this,e.next)},e.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},e.prototype.updateCurrentAttributes_=function(){var t,e=this.codeMirror,r=e.indexFromPos(e.getCursor("anchor")),n=e.indexFromPos(e.getCursor("head"));t=r>n?n+1:n;var o=this.annotationList_.getAnnotatedSpansForPos(t);if(this.currentAttributes_={},o.length>0)for(var i in o[0].annotation.attributes)this.currentAttributes_[i]=o[0].annotation.attributes[i]},r.prototype.equals=function(t){if(!(t instanceof r))return!1;var e;for(e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},e}();var t=t||{};t.RichTextCodeMirrorAdapter=function(){"use strict";function e(t){this.rtcm=t,this.cm=t.codeMirror,s(this,"onChange"),s(this,"onAttributesChange"),s(this,"onCursorActivity"),s(this,"onFocus"),s(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function r(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function n(t,e){return 0===r(t,e)}function o(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function i(t,e){if(!t)throw Error(e||"assertion error")}function s(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}function a(t){for(var e in t)return!1;return!0}var h=t.TextOperation,u=t.WrappedOperation,c=t.Cursor;e.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},e.operationFromCodeMirrorChange=function(t,e){for(var r=[],n=0;t;)r[n++]=t,t=t.next;var i=o(e),s=(new h).retain(i),a=(new h).retain(i);for(n=r.length-1;n>=0;n--){t=r[n];var u=t.start,c=i-u-t.text.length;s=(new h).retain(u)["delete"](t.removed.length).insert(t.text,t.attributes).retain(c).compose(s),a=a.compose((new h).retain(u)["delete"](t.text.length).insert(t.removed,t.removedAttributes).retain(c)),i+=t.removed.length-t.text.length}return[s,a]},e.operationFromAttributesChange=function(t,e){for(var r=o(e),n=new h,s=new h,a=0;t;){var u=t.start-a;i(u>=0),n.retain(u),s.retain(u);var c=t.end-t.start;n.retain(c,t.attributes),s.retain(c,t.attributesInverse),a=t.start+c,t=t.next}return n.retain(r-a),s.retain(r-a),[n,s]},e.applyOperationToCodeMirror=function(t,e){e.codeMirror.operation(function(){for(var r=t.ops,n=0,o=0,i=r.length;i>o;o++){var s=r[o];s.isRetain()?(e.updateTextAttributes(n,n+s.chars,s.attributes,"RTCMADAPTER"),n+=s.chars):s.isInsert()?(e.insertText(n,s.text,s.attributes,"RTCMADAPTER"),n+=s.text.length):s.isDelete()&&e.removeText(n,n+s.chars,"RTCMADAPTER")}})},e.prototype.registerCallbacks=function(t){this.callbacks=t},e.prototype.onChange=function(t,r){if("RTCMADAPTER"!==r.origin){var n=e.operationFromCodeMirrorChange(r,this.cm);this.trigger("change",n[0],n[1])}},e.prototype.onAttributesChange=function(t,r){if("RTCMADAPTER"!==r.origin){var n=e.operationFromAttributesChange(r,this.cm);this.trigger("change",n[0],n[1])}},e.prototype.onCursorActivity=e.prototype.onFocus=function(){this.trigger("cursorActivity")},e.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},e.prototype.getValue=function(){return this.cm.getValue()},e.prototype.getCursor=function(){var t,e=this.cm,r=e.getCursor(),o=e.indexFromPos(r);if(e.somethingSelected()){var i=e.getCursor(!0),s=n(r,i)?e.getCursor(!1):i;t=e.indexFromPos(s)}else t=o;return new c(o,t)},e.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))};var p=function(){if("undefined"!=typeof document){var t={},e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e);var r=e.sheet;return function(e){t[e]||(t[e]=!0,r.insertRule(e,(r.cssRules||r.rules).length))}}}();return e.prototype.setOtherCursor=function(t,e,r){var n=this.cm.posFromIndex(t.position);if(t.position===t.selectionEnd){var o=this.cm.cursorCoords(n),i=document.createElement("pre");return i.className="other-client",i.style.borderLeftWidth="2px",i.style.borderLeftStyle="solid",i.innerHTML="&nbsp;",i.style.borderLeftColor=e,i.style.height=.9*(o.bottom-o.top)+"px",i.style.marginTop=o.top-o.bottom+"px",i.setAttribute("data-clientid",r),i.style.zIndex=0,this.cm.addWidget(n,i,!1),{clear:function(){var t=i.parentNode;t&&t.removeChild(i)}}}if("string"==typeof e){var s="selection-"+e.replace("#",""),a="."+s+" { background: "+e+"; }";p(a);var h,u;return t.selectionEnd>t.position?(h=n,u=this.cm.posFromIndex(t.selectionEnd)):(h=this.cm.posFromIndex(t.selectionEnd),u=n),this.cm.markText(h,u,{className:s})}},e.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},e.prototype.applyOperation=function(t){e.applyOperationToCodeMirror(t,this.rtcm)},e.prototype.registerUndo=function(t){this.cm.undo=t},e.prototype.registerRedo=function(t){this.cm.redo=t},e.prototype.invertOperation=function(t){for(var e,r,n=0,o=this.rtcm.codeMirror,i=new h,s=0;t.wrapped.ops.length>s;s++){var c=t.wrapped.ops[s];if(c.isRetain())if(a(c.attributes))i.retain(c.chars),n+=c.chars;else for(e=this.rtcm.getAttributeSpans(n,n+c.chars),r=0;e.length>r;r++){var p={};for(var l in c.attributes){var f=c.attributes[l],d=e[r].attributes[l];f===!1?d&&(p[l]=d):f!==d&&(p[l]=d||!1)}i.retain(e[r].length,p),n+=e[r].length}else if(c.isInsert())i["delete"](c.text.length);else if(c.isDelete()){var g=o.getRange(o.posFromIndex(n),o.posFromIndex(n+c.chars));e=this.rtcm.getAttributeSpans(n,n+c.chars);var v=0;for(r=0;e.length>r;r++)i.insert(g.substr(v,e[r].length),e[r].attributes),v+=e[r].length;n+=c.chars}}return new u(i,t.meta.invert())},e}();var t=t||{};return t.Firepad=function(e){function r(t,e,o){if(!(this instanceof r))return new r(t,e,o);if(!l)throw Error("Couldn't find CodeMirror.  Did you forget to include codemirror.js?");if(e instanceof l){this.codeMirror_=e;var i=this.codeMirror_.getValue();if(""!==i)throw Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else this.codeMirror_=new l(e);var h=this.codeMirror_.getWrapperElement();this.firepadWrapper_=p.elt("div",null,{"class":"firepad"}),h.parentNode.replaceChild(this.firepadWrapper_,h),this.firepadWrapper_.appendChild(h),this.codeMirror_.firepad=this,this.options_=o||{},this.getOption("richTextShortcuts",!1)&&(l.keyMap.richtext||r.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar");var f=this.getOption("userId",t.push().name()),d=this.getOption("userColor",n(f));this.richTextCodeMirror_=new a(this.codeMirror_,{cssPrefix:"firepad-"}),this.firebaseAdapter_=new u(t,f,d);var g=new s(this.richTextCodeMirror_);new c(this.firebaseAdapter_,g);var v=this;this.firebaseAdapter_.on("ready",function(){v.ready_=!0,v.trigger("ready")})}function n(t){for(var e=1,r=0;t.length>r;r++)e=17*(e+t.charCodeAt(r))%360;var n=e/360;return i(n,.75,.5)}function o(t,e,r){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(r)}function i(t,e,r){if(0===e)return o(r,r,r);var n=.5>r?r*(1+e):r+e-e*r,i=2*r-n,s=function(t){return 0>t&&(t+=1),t>1&&(t-=1),1>6*t?i+6*(n-i)*t:1>2*t?n:2>3*t?i+6*(n-i)*(2/3-t):i};return o(s(t+1/3),s(t),s(t-1/3))}var s=t.RichTextCodeMirrorAdapter,a=t.RichTextCodeMirror,h=t.RichTextToolbar,u=t.FirebaseAdapter,c=t.EditorClient,p=t.utils,l=e.CodeMirror;return p.makeEventEmitter(r),r.fromCodeMirror=r,r.prototype.getText=function(){return this.assertReady_("getText"),this.codeMirror_.getValue()},r.prototype.setText=function(t){return this.assertReady_("setText"),this.codeMirror_.setValue(t)},r.prototype.getHtml=function(){for(var t=this.firebaseAdapter_.getDocument(),e="",r=0;t.ops.length>r;r++){var n=t.ops[r],o=n.attributes;p.assert(n.isInsert());var i="",s="";for(var a in o){var h;"b"===a||"i"===a||"u"===a?(p.assert(o[a]===!0),h=a):"h"===a?(p.assert("number"==typeof o[a]&&o[a]>=1&&3>=o[a]),h="h"+o[a]):p.assert(!1,"Encountered unknown attribute while rendering html."),i+="<"+h+">",s="</"+h+">"+s}e+=i+this.textToHtml_(n.text)+s}return e},r.prototype.textToHtml_=function(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>")},r.prototype.setHtml=function(){throw Error("Not implemented yet.  Sorry!")},r.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},r.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute("b"),this.codeMirror_.focus()},r.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute("i"),this.codeMirror_.focus()},r.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute("u"),this.codeMirror_.focus()},r.prototype.fontSize=function(t){this.richTextCodeMirror_.setAttribute("fs",t),this.codeMirror_.focus()},r.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},r.prototype.assertReady_=function(t){if(!this.ready_)throw Error('You must wait for the "ready" event before calling '+t+".")},r.prototype.addToolbar_=function(){var t=new h;t.on("bold",this.bold,this),t.on("italic",this.italic,this),t.on("underline",this.underline,this),t.on("font-size",this.fontSize,this),this.firepadWrapper_.insertBefore(t.element(),this.firepadWrapper_.firstChild)},r.initializeKeyMap_=function(){function t(t){t.firepad.bold()}function e(t){t.firepad.italic()}function r(t){t.firepad.underline()}l.keyMap.richtext={"Ctrl-B":t,"Cmd-B":t,"Ctrl-I":e,"Cmd-I":e,"Ctrl-U":r,"Cmd-U":r,fallthrough:["default"]}},r}(this),t.Firepad}();